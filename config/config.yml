parameters:
    # Workaround for doctrine/doctrine-migrations-bundle:^3.0
    # To be able to use multiple connections, the bundle requires a default connection.
    # See https://github.com/marein/php-gaming-website/issues/62.
    doctrine.migrations.preferred_connection: default

imports:
    - { resource: chat/config.yml }
    - { resource: connect-four/config.yml }
    - { resource: identity/config.yml }
    - { resource: web-interface/config.yml }

framework:
    secret: '%env(APPLICATION_KERNEL_SECRET)%'
    validation:
        enabled: true
    router:
        resource: "%kernel.project_dir%/config/routing.yml"

doctrine:
    dbal:
        types:
            uuid_binary_ordered_time: Ramsey\Uuid\Doctrine\UuidBinaryOrderedTimeType
            uuid_binary: Ramsey\Uuid\Doctrine\UuidBinaryType
        mapping_types:
            uuid_binary_ordered_time: binary
            uuid_binary: binary

monolog:
    handlers:
        application_error:
            type: stream
            path: "php://stderr"
            level: error

twig:
    strict_variables: '%kernel.debug%'

services:

    gaming.message-broker:
        class: Gaming\Common\Port\Adapter\Messaging\AmqpTopicExchangeMessageBroker
        public: false
        arguments:
            - '%env(APPLICATION_RABBIT_MQ_DSN)%'
            - 'gaming'

    gaming.consume-messages-command:
        class: Gaming\Common\Port\Adapter\Symfony\ConsumeMessagesCommand
        public: false
        arguments:
            - '@gaming.message-broker'
            - !tagged { tag: 'gaming.consumer', index_by: 'key' }
        tags:
            - { name: console.command, command: gaming:consume-messages, description: 'Consume messages.' }

    # Custom exception listener for the gaming domain.
    # Lower priority so that the profiler is respected.
    # todo: This can be removed as soon as https://github.com/marein/php-gaming-website/issues/34 is done.
    gaming.exception-to-json-listener:
        class: Gaming\Common\Port\Adapter\Symfony\GamingExceptionListener
        public: false
        tags:
            - { name: kernel.event_listener, event: kernel.exception, priority: -100 }

    # Lower priority so that the profiler is respected.
    gaming.application-exception-to-json-listener:
        class: Gaming\Common\Port\Adapter\Symfony\TransformApplicationExceptionListener
        public: false
        arguments:
            - []
        tags:
            - { name: kernel.event_listener, event: kernel.exception, priority: -99 }
